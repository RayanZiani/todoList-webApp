<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ToDo List</title>
    <link rel="stylesheet" href="../static/style.css">
</head>

<script src="https://unpkg.com/feather-icons"></script>
<body>
    <div class="logoHeader">
        <div class="logoHeader__style"><a href="/" >ToDo List</a></div>
    </div>
    <nav class="navbar">
      <ul class="navbar__menu">
        <li class="navbar__item">
          <a href="/" class="navbar__link"><i data-feather="pie-chart"></i><span>Dashboard</span></a>
        </li>
        <li class="navbar__item">
          <a href="/add" class="navbar__link"><i data-feather="plus-square"></i><span>Ajouter</span></a>
        </li>
        <li class="navbar__item">
          <a href="/todo" class="navbar__link"><i data-feather="list"></i><span>ToDo</span></a>
        </li>
        <li class="navbar__item">
          <a href="#" class="navbar__link"><i data-feather="trash-2"></i><span>Corbeille</span></a>
        </li>
        <li class="navbar__item">
          <a href="#" class="navbar__link"><i data-feather="tool"></i><span>Réglages</span></a>
        </li>
        <li class="navbar__item navbar__item--bottom" style="bottom: 10%!important">
          <a href="#" class="navbar__link"><i data-feather="sun"></i><span>Logout</span></a>
        </li>
      </ul>
    </nav>

    <svg viewBox="0 0 0 0" style="position: absolute; z-index: -1; opacity: 0;">
      <defs>
        <linearGradient id="boxGradient" gradientUnits="userSpaceOnUse" x1="0" y1="0" x2="25" y2="25">
          <stop offset="0%"   stop-color="rgba(71, 114, 234, 0.81)"/>
          <stop offset="100%" stop-color="#406ff3"/>
        </linearGradient>

        <linearGradient id="lineGradient">
          <stop offset="0%"    stop-color="rgba(71, 114, 234, 0.81)"/>
          <stop offset="100%"  stop-color="#406ff3"/>
        </linearGradient>

        <path id="todo__line" stroke="url(#lineGradient)" d="M21 12.3h168v0.1z"></path>
        <path id="todo__box" stroke="url(#boxGradient)" d="M21 12.7v5c0 1.3-1 2.3-2.3 2.3H8.3C7 20 6 19 6 17.7V7.3C6 6 7 5 8.3 5h10.4C20 5 21 6 21 7.3v5.4"></path>
        <path id="todo__check" stroke="url(#boxGradient)" d="M10 13l2 2 5-5"></path>
        <circle id="todo__circle" cx="13.5" cy="12.5" r="10"></circle>
      </defs>
    </svg>


    <div class="todo-list">
        {% for task in tasks %}
      <label class="todo target target-dark" data-id="{{ task.id }}" id="task-{{ task.id }}" >
        <div class="todo__form">
          <input class="todo__state" type="checkbox" />

          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 200 25" class="todo__icon">
            <use xlink:href="#todo__line" class="todo__line"></use>
            <use xlink:href="#todo__box" class="todo__box"></use>
            <use xlink:href="#todo__check" class="todo__check"></use>
            <use xlink:href="#todo__circle" class="todo__circle"></use>
          </svg>

          <div class="todo__text">{{ task.title }}</div>
          <p class="todo_desciption tooltip" style="word-wrap: break-word"><b>Note:</b> {{ task.description }}</p>
        </div>
      </label>
        {% endfor %}
    </div>

    <!--
    <div id="context-menu" class="context-menu">
        <button class="deleteButton" type="button" data-id=""><i data-feather="trash"></i></button>
    </div>
    -->


<!--
    <div class="container">
         {% for task in tasks %}
            <ul class="temp" id="taskList">
                <li id="task-{{ task.id }}">
                    <div class="todo_columns">
                        <div class="todo_leftSection">
                            <p class="todo_title">{{ task.title }}</p>
                            <p class="todo_desciption tooltip" style="word-wrap: break-word"><b>Note:</b> {{ task.description }}</p>
                            <p class="due_date"><strong>Pour le :</strong> {{ task.due_date.strftime('%d/%m/%Y') }}</p>
                        </div>
                        <div class="todo_rightSection">
                            <span class="creation_date">{{ task.creation_date.strftime('%d/%m/%Y %H:%M:%S') }}</span>
                            <button class="buttonError" type="button" data-id="{{ task.id }}"><i data-feather="trash"></i></button>
                        </div>
                    </div>

                </li>
            </ul>
        <hr>
        {% endfor %}
    </div>
-->


    <!-- ____________ JavaScript ____________ -->

    <!-- js -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../static/js/main.js"></script>

    <!-- dom for context menu -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
          let currentTaskId = null; // store task.id when menu opens

          const menuItems = [
          {
              content: `${copyIcon}Copy`,
              events: {
                click: function (e) {
                  e.preventDefault();

                  if (!currentTaskId) {
                    console.error("No task ID available for copying");
                    return;
                  }

                  console.log(`Task ID: ${currentTaskId} - Copy button clicked`);

                  // Fetch task details from your backend
                  fetch(`/tasks/${currentTaskId}`)
                    .then(response => response.json())
                    .then(data => {
                      if (data.success && data.task) {
                        // Create a JSON object with the task details
                        const taskDetails = {
                          title: data.task.title,
                          due_date: data.task.due_date,
                          creation_date: data.task.creation_date,
                          description: data.task.description
                        };

                        // Convert task details to JSON format
                        const taskDetailsJSON = JSON.stringify(taskDetails, null, 2);

                        // Copy the JSON string to the clipboard
                        navigator.clipboard.writeText(taskDetailsJSON).then(() => {
                          console.log("Task details copied to clipboard:", taskDetailsJSON);
                          alert("Task details copied to clipboard!");
                        }).catch(err => {
                          console.error("Failed to copy task details:", err);
                          alert("Failed to copy task details.");
                        });
                      } else {
                        console.error("Task not found or error occurred while fetching task details.");
                        alert("Task not found.");
                      }
                    })
                    .catch(error => {
                      console.error("Error while fetching task details:", error);
                      alert("An error occurred while fetching task details.");
                    });
                }
              }
            },
            //{ content: `${pasteIcon}Paste` },
            //{ content: `${cutIcon}Cut` },
            {
              content: `${downloadIcon}Download`,
              events: {
                click: function (e) {
                  e.preventDefault();

                  if (!currentTaskId) {
                    console.error("No task ID available for downloading");
                    return;
                  }

                  console.log(`Task ID: ${currentTaskId} - Download button clicked`);

                  // Fetch task details from your backend
                  fetch(`/tasks/${currentTaskId}`)
                    .then(response => response.json())
                    .then(data => {
                      if (data.success && data.task) {
                        // Create a JSON object with the task details
                        const taskDetails = {
                          title: data.task.title,
                          due_date: data.task.due_date,
                          creation_date: data.task.creation_date,
                          description: data.task.description
                        };

                        // Convert task details to CSV format
                        const csvContent = convertToCSV([taskDetails]);

                        // Create a blob with the CSV content
                        const blob = new Blob([csvContent], { type: "text/csv" });
                        const url = URL.createObjectURL(blob);

                        // Create a link and trigger the download
                        const a = document.createElement("a");
                        a.href = url;
                        a.download = `task_${currentTaskId}.csv`;
                        a.click();

                        // Clean up the object URL after download
                        URL.revokeObjectURL(url);
                      } else {
                        console.error("Task not found or error occurred while fetching task details.");
                        alert("Task not found.");
                      }
                    })
                    .catch(error => {
                      console.error("Error while fetching task details:", error);
                      alert("An error occurred while fetching task details.");
                    });
                }
              }
            },
            {
              content: `${dateIcon} Details`,
              divider: "top",
              events: {
                click: function (e) {
                  e.preventDefault();

                  if (currentDueDate, creationDate) {
                    alert(`Ajouté le: ${creationDate} et à faire pour le: ${currentDueDate}`);
                  } else {
                    alert("Due date and creation date not available.");
                  }
                }
              }
            },
            {
              content: `${deleteIcon}Delete`,
              divider: "top",
              events: {
                click: function (e) {
                  e.preventDefault();

                  // debug task id
                  if (!currentTaskId) {
                    console.error("No task ID available for deletion");
                    return;
                  }

                  console.log(`Task ID: ${currentTaskId} - Delete button clicked`);

                  // Proceed to delete the task
                  fetch(`/tasks/${currentTaskId}/delete`, {
                    method: "DELETE",
                    headers: {
                      "Content-Type": "application/json"
                    }
                  })
                  .then(response => response.json())
                  .then(data => {
                    console.log("Response from server:", data);

                    if (data.success) {
                      // if everything's fine
                      const taskItem = document.getElementById(`task-${currentTaskId}`);
                      if (taskItem) {
                        taskItem.remove();
                        console.log(`Task ${currentTaskId} removed from DOM`);
                      }
                    } else {
                      alert("Erreur lors de la suppression de la tâche.");
                    }
                  })
                  .catch(error => {
                    console.error("Erreur lors de la requête de suppression :", error);
                    alert("Une erreur est survenue lors de la suppression.");
                  });
                }
              }
            }
          ];

          // darktheme
          const darkMenu = new ContextMenu({
            target: ".target-dark",
            menuItems
          });

          darkMenu.init();

          // Override the context menu to capture the task ID and due date
          document.querySelectorAll(".target-dark").forEach(task => {
            task.addEventListener("contextmenu", async function (e) {
              currentTaskId = this.getAttribute("data-id");
              console.log(`Context menu opened on Task ID: ${currentTaskId}`);

              // Fetch task details to get the due date before displaying the context menu
              await fetch(`/tasks/${currentTaskId}`)
                .then(response => response.json())
                .then(data => {
                  if (data.success && data.task) {
                    currentDueDate = data.task.due_date;
                    creationDate = data.task.creation_date;
                    console.log(`Due date for task ${currentTaskId} is: ${currentDueDate}`);
                    console.log(`Creation date for task ${currentTaskId} is: ${creationDate}`);
                  } else {
                    currentDueDate = null;
                    creationDate = null;
                    console.error("Task not found or error occurred while fetching task details.");
                  }
                })
                .catch(error => {
                  console.error("Error while fetching task details:", error);
                  currentDueDate = null;
                  creationDate = null;
                });
            });
          });
        });
        // Function to convert JSON to CSV format
        function convertToCSV(arr) {
          const keys = Object.keys(arr[0]);
          const csvRows = [];

          // Add header
          csvRows.push(keys.join(','));

          // Add rows
          for (const row of arr) {
            const values = keys.map(key => `"${row[key]}"`);
            csvRows.push(values.join(','));
          }

          return csvRows.join('\n');
        }
    </script>
</body>
</html>